name: CI

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  lint-and-quality:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v3

      - name: Install dev tools (ruff, black, pylint)
        run: |
          uv add --dev ruff black pylint

      - name: Ruff lint
        run: uv run ruff check .

      - name: Ruff format check
        run: uv run ruff format --check .

      - name: Black format check
        run: uv run black --check .

      - name: Pylint
        run: uv run pylint market_streaming tests

  smoke-tests:
    runs-on: ubuntu-latest
    needs: lint-and-quality
    services:
      kafka:
        image: apache/kafka:latest
        ports:
          - 9092:9092
        options: >-
          --health-cmd="bash -c 'echo > /dev/tcp/localhost/9092'" 
          --health-interval=10s 
          --health-timeout=5s 
          --health-retries=10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v3

      - name: Run smoke integration test
        env:
          PYTHONPATH: src
        run: |
          uv run python -m pytest tests/test_pipeline_integration.py::test_pipeline_smoke -v
